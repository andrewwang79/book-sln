# 交易设计

## 业务

* 一个订单对应一个付款单，多个退款单，多个运单(包裹)  订单，支付单，包裹，物流单之间的流转和关系
* 一个付款单多个明细，一个退款单多个明细
* 退换货流程

## 模块

### 下单

* 订单编号
  * 订单号无重复。
  * 日期加随机数
  * 订单池
* 生成订单之后，修改商品库存。

#### 下单流程

  ```

    //生成Order
    createOrder(itemDataList);

    //生成OrderItemSku,OrderPromotion
    for(Map map:itemDataList){
        //生成OrderItemSku
        OrderItemSku orderItemSku=createOrderItemSku(map);
        //生成OrderPromotion
        OrderPromotion orderPromotion=createOrderPromotion(map,orderItemSku);
    }

    //支付
    toPay(orderList);

    if(支付成功){

        //打包，放到消息队列中去做
        createPackage(order);

        //发货，放到消息队列中去做
        send(order);

        return 成功；
    }else{
        throw new 异常；
    }


  ```

### 取消订单

* 下单成功，支付之前的订单，可以取消。
* 退还订单使用的优惠券。

### 支付

#### 支付方案
1. 生成支付单（支付状态，外部交易号，外部交易code，外部交易msg，支付超时时间），调第三方支付。
1. 重复支付，后来的自动退款。
1. 订单和支付单的关系通过OrderPayOrder建立。一个订单，至多对应一个支付单。
1. 订单A单独支付，生成支付单。在另外一个设备上，订单ABC合并支付，给友好提示，允许支付。按照支付平台的回调顺序，决定退款。按照支付单退款。

#### 支付宝&微信支付
* 点击一次支付宝，生成一个支付单。

#### 找人代付
* 下单，生成支付单A。代付单和支付单A关联，代付人通过支付单A付款。

#### 多订单合并支付
1. 订单和支付单的关系：
    * 一个订单，对应一个有效的支付单。
    * 多个订单，可以对应一个支付单。（多订单合并支付）
1. 多订单合并支付，生成一个支付单。支付超时，不能修改支付单状态，也不能再支付。【区别订单超时】
1. 多订单合并，再次支付，会重新生成一个支付单。
1. 如有订单处于其他活跃状态的合并支付单中，则无法支付该订单

####　重复支付解决方案

用户点击一次支付，就会生成一个支付单。支付单的过期时间跟随订单走。

* 两个终端，分别用支付宝和微信支付订单，回调的时候，检查该订单的其他支付单状态。如果已支付，就对最后一次付款，最退款处理。
* 一个终端，选择代付，代付人和自己分别支付，回调的时候，检查该订单的其他支付单状态。如果已支付，就对最后一次付款，最退款处理。

###发货

```

if (实物商品包裹) {
    switch (配送方式) {
        case 普通快递:
            商家填写物流信息(物流公司和物流单)，直接发货给买家，买家接收
        case 惠民代送:
            商家填写物流信息，发货给自提点，通知买家自提
        case 惠民代送:
            商家填写物流信息，发货给送货点。送货人员送货上门，买家接收
        case 现场提货:
            支付完成，系统自动发货。买家确认收货之后，订单状态到已完成（跳过申请退货环节）
    }
} else {
    // 卡券商品包裹。无需物流，系统自动发货(服务也是一种虚拟商品，如手机充值/美团优惠券/家政体验券)
    switch (商户) {
        case 我方: // 如已进入我方库存美团优惠券
            从仓库获取库存商品，发货，返回结果
        case 第三方: // 如手机充值
            发送给第三方让其发货，第三方返回结果
    }
    if (多次发货失败)
        退款，取消订单
    if (发货成功)
        处理商品 // 不属于商城标准流程，特定业务自定义。如优惠券要进入我的优惠券。手机充值进入我的充值记录。
}

```

###服务工单

* 用户下单，选择惠民代送或惠民代收。生成订单，服务订单。
* 卖家发货之后，根据服务订单，生成服务工单。

### 多商户/多商品，订单方案

商品描述:

|商型|实例|说明|
|:--------:|:--------:|
|实物|大米，牛奶，手机|正常的电商购物流程|
|卡券|游戏点券，手机充值卡|游戏点券：购买成功的同时就使用完成。充值卡：购买之后，获得一个卡密，可以在规定的时间内使用。|

购物流程描述:

|商品类型|能否加购物车|一次可买多个|订单|包裹|物流|
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
|实物|是|是|一个商家一个单|有|可有可无|
|卡券|否|否|一个|无|无|  

### 订单优惠记录

``````
OrderPromotion:
{
    "orderId":1721315,
    "createtime":"2017-05-18 14:44:25",
    "bizId":12321,
    "bizType":"fullCut",
    "preferentialResult":[
        {
            "orderItemSkuId":172131501,
            "preferential_price":23,
        },
        {
            "orderItemSkuId":172131502,
            "preferentialPrice":27
        }
    ]
}

``````

###退款

* 用户下单，支付成功，在卖家发货之前，可以选择订单退款。
* 订单完成之后，可以选择退货，走退货流程，最后退款。

###退货

* 订单完成之后可以申请退货

###订单删除

* 订单完成，已经过了退货有效期。用户可以删除订单。
* 不是订单删除，是订单隐藏。由订单表上一个bool字段(用户删除)控制。

### 订单，退货单，工单，代付单，支付单的状态

#### 订单的状态

|名称|状态|操作|
|:--------:|:--------:|:--------:|
|等待买家付款|WAIT_BUYER_PAY|买家付款|
|支付超时关闭|CLOSED_BY_EXPIRE|删除订单|
|订单异常，交易关闭|CLOSED_BY_SYS|删除订单|
|取消订单|CLOSED_BY_BUYER|删除订单|
|商家取消，交易关闭|CLOSED_BY_SELLER|删除订单|
|等待卖家发货|WAIT_SELLER_SEND_GOODS|卖家发货|
|确认收货|WAIT_BUYER_CONFIRM_GOODS|确认收货|
|完成|FINISHED|申请退货|
|退货成功|CLOSED_BY_RETURN||
|退款成功|CLOSED_BY_REFUND|买家付款|

#### 退货单的状态

|名称|状态|操作|
|:--------:|:--------:|:--------:|
|申请退货|BUYER_APPLY|卖家审核|
|买家退货|SELLER_AGREE|买家退货|
|退货关闭|SELLER_REFUSE|卖家拒绝退货|
|买家已经退货|BUYER_RETURN|卖家确认收货|
|卖家收货|SELLER_RECEIVE|卖家审核货|
|等待卖家发货|WAIT_SELLER_SEND_GOODS|卖家发货|
|退货完成|RETURN|卖家退款|
|退款完成|REFUND|退款完成|
|退货关闭|CLOSED_BUYER|退款关闭,买家发货超时|

#### 工单的状态

|名称|状态|操作|
|:--------:|:--------:|:--------:|
|送往站点中|delivery_start|transporting|
|确认收货|delivery_store|atStore|
|立即送货|delivery_instantly|inDelivery|
|代送完成|delivery_complete|delivered|
|核对身份信息|check_identity|picking|
|代收完成|collect_complete|picked|

#### 代付单的状态

|名称|状态|操作|
|:--------:|:--------:|:--------:|
|等待代付方付款|WAIT_RESPONSE_PAY||
|付款成功,关闭|CLOSED||
|超时，关闭付款|CLOSED_BY_EXPIRE||
|已退款|CLOSED_BY_REFUND||
|订单已完成|CLOSED_BY_REQUEST||
|订单已取消|CLOSED_BY_CANCE||

#### 支付单的状态

|名称|状态|操作|
|:--------:|:--------:|:--------:|
|等待买家付款|WAIT_BUYER_PAY||
|买家已支付|FINISHED||
|支付取消,关闭|CLOSED_BY_CANCEL||
|支付超时，关闭|CLOSED_BY_EXPIRE||

### 超时处理

#### 订单的超时处理

|行为|超时时间|超时处理|平台仲裁|说明|
|:--------:|:--------:|:--------:|:--------:|:--------:|
|买家待付款|30分钟	|系统自动取消，取消支付平台的支付订单(非业务)|||
|买家已付款，卖家未发货|2天（周六日及法定节假日除外）|系统自动取消，退款|||
|卖家发货后，用户待收货|7天（自然日）|系统自动收货|||
|买家退货申请（收货开始计算）|7天（自然日）|买家无法发起退货申请|开放|买家点击确认收货才可以退货|

#### 退货单的超时处理

|行为|超时时间|超时处理|平台仲裁|说明|
|:--------:|:--------:|:--------:|:--------:|:--------:|
|买家退货申请（收货开始计算）|7天（自然日）|买家无法发起退货申请|开放|买家点击确认收货才可以退货|
|卖家的退货审核（买家提交服务单开始计算）|卖家的退货审核（买家提交服务单开始计算）|系统自动审核通过，同意买家发货|||
|买家退货（卖家审核通过开始计算）|5天（自然日）|关闭当前退货|开放|||
|卖家收货&处理（买家发货开始计算）|5天（自然日）|系统自动收货，全额退款||包含物流配送时间，对服务单进行收货及处理操作|
|卖家退款（卖家同意退款开始计算）|3天|系统自动退款|||

#### 代收工单的超时处理

|行为|超时时间|超时处理|平台仲裁|说明|
|:--------:|:--------:|:--------:|:--------:|:--------:|
|商家发货|3天（自然日）|系统自动确认代收|||
|完成服务|4天（自然日）|系统自动完成服务|||

#### 代送工单的超时处理

|行为|超时时间|超时处理|平台仲裁|说明|
|:--------:|:--------:|:--------:|:--------:|:--------:|
|商家发货|3天（自然日）|系统自动确认代收|||
|开始配送|1天（自然日）|系统自动开始配送|||
|完成服务|4天（自然日）|系统自动完成服务|||

### 参考
1. 京东：卡券类商品单独购买，生成一个订单。实物商品，根据不同库房或不同商家，拆分为多个订单。有一个父订单。
1. 淘宝：卡券类商品单独购买，生成一个订单。实物商品，根据商家不同，拆分为多个订单，没有父订单。
