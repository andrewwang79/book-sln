# 业务
## 基础业务
### 添加税
进项税/销项税，供应商(进项税)，税率，是否免税

### 添加供应商

### 添加货品

### 添加仓库

### 入库
输入参数：类型，单号，List<货品，货品批次(可选)，数量，进价>
```java
each (货品) {
 新增货品批次
 增加库存
}

入库单(入库单货品对应新增的货品批次)
```

### 出库
输入参数：类型，单号，List<货品，货品批次/入库单，数量>
```java
锁定所有的货品库存/货品批次

// 库存不够的风险，需先检查
if (指定了货品批次) {
  each (货品) {
    if (货品批次.库存 不足)
      异常
} else {
  each (货品) {
    else if (货品库存 不足)
        异常
  }
}

each (货品) {
  if (指定了货品批次)
    减少货品批次的数量
  else {
    while (货品批次 = (有货 && 入库最早))
      减少货品批次的数量
  }
  减少货品库存
}

出库单(出库单货品对应减少的货品批次，出库单货品的进价=货品批次的进价)
```

## 核心业务
### 销货(销售)
```java
生成销货单
出库
```

### 销货退货(销售退货)
* 必须通过小票退货，通过小票关联到销货单
* 先进后出原则选择退货的批次：如销货单的商品A有2个，分别对应了批次1和批次2。如要退一个商品A时，退的是批次2

```java
生成销货退货单
if (销货单) {
  入库
} else { // 无需实现的业务
  销货单 = 匹配七天内符合货品的最近的销货单 // 最近优先
  if (销货单) {
    入库
  } else { // 无完全匹配的，说明是多个销货退货单的合并退货
    each (货品) {
      销货单 = 匹配符合货品的最近的销货单 // 最近优先
      if (!销货单) {
        异常
      }
      入库
    }
  }
}
```

### 采购
采购入库单要有货品的进项税

1. 选择仓库 // 发货单可直接关联到门店
1. 入库

### 采购退货
必须关联到货品批次

1. 选择货品，货品批次/入库单(入库单有关系到货品批次)，数量
1. 出库

### 报损
```java
出库(报损)
```

### 采购输入错误
1. 数量错误
  1. 多了：采购退货
  1. 少了：采购
1. 金额错误
  1. 采购退货，重新采购

### 调拨
* 调拨单审核通过后，会生成仓库A的出库单和仓库B的入库单，可以分批运输。
* 批次是入库批次，采购批次，生产批次？

## 运营业务
### 库存结余
1. 周期是自然月，结余单位是仓库货品

1. 计算
  * 基于当月的入库单和出库单计算周期的出入库结余
  * 基于上个周期的库存结余和本周期的出入库结余，计算本周期的库存结余
1. 公式
  * 数量 = 仓库货品数量
  * 税前金额 = sum(货品批次A的进价 * 货品批次A的数量)
  * 税额 = 税前金额 * 税率
  * 价税合计 = 税前金额 + 税额

### 盘点

# 设计
## 原则
1. 信息流，物流，资金流
1. 每个业务行为都有单据
1. 对财务报表有影响的行为都需要审核，如采购，报损。

## 方案
* 采购退货：必须要有入库单/货品批次，出库单货品自动关联价格
* 销货退货：必须要有销货单
* 账单结构：期初，入，出，期末
* 进项税和销项税
  * 进项税是采购过程发生的(供应商开票)，销项税是销货过程发生的(公司开票)
  * 进项税在每次采购入库时每个货品分别设置(或者自动关联自供应商货品的进项税记录表)，相当于每批货品批次都有进项税
  * 销项税记录在货品上，一个货品在一个时间周期内只有一种税
  * 进项税要保存到每次的采购入库单，销项税要保存到每次的销货单
* 代销TODO

## 单据格式

| 单据 | 示例 | 说明 | 用途 |
| :----: | ---- | ---- |
| 库存调整单 | 6170620000001 | 2017年6月20日，每天有6位 | 库存变化 |

# 资料
## 存货计价方法
与存货本身实际发出先后顺序无关
1. [先进先出](https://baike.baidu.com/item/%E5%85%88%E8%BF%9B%E5%85%88%E5%87%BA/9629304)
1. 均价：每次进货入库的成本加上当前库存存货的成本，除以每次进货数量与原有库存数量之和
